<center><span id="errors"></span></center>
<div class="property-page">
<center><h2><a href="<%= property_url(@property) %>"><%= @property.address %> <%= @property.floor %> Floor</a></h2>

<% @properties.each do |property| %>
  <% if property == @property %>
    <% class_str = "btn btn-default current-button" %>
  <% else %>
    <% class_str = "btn btn-default" %>
  <% end %> 
  <%= link_to "#{property.address} #{property.floor} Floor", dashboard_url(property), class: class_str %>
<% end %></center>

<br><br>


<div class="diagram2">
<form id="property-form">


<div class="top-box">
  <div class="purchase-price2">

    <label for="property_purchase_price">Purchase Price</label><br>
    &#36; <input
      class="number"
      id="property_purchase_price"
      name="property[purchase_price]"
      value="<%= @property.purchase_price.to_i %>"><br><br>

  </div>
  <div class="loan-amount2">

    <label for="property_loan_amount">Loan Amount</label><br>
    &#36; <input
      id="property_loan_amount"
      name="property[loan_amount]"
      type="number"
      step="1"
      value="<%= @property.loan_amount.to_i %>"><br><br>

  </div>
  <div class="interest-rate2">

    <label for="property_interest_rate">Interest Rate</label><br>
    <input
      id="property_interest_rate"
      name="property[interest_rate]"
      type="number"
      step="0.01"
      value="<%= remove_trailing_zeros(@property.interest_rate) %>"> &#37;<br><br>

  </div>
  <div class="interest-only2">

    <label for="property_interest_only">Interest Only</label><br>
    <input id="interest-only-yes" type="radio" name="property[interest_only]" value="Yes" <%= "checked" if @property.interest_only %>> Yes&nbsp;&nbsp;&nbsp;
    <input id="interest-only-no" type="radio" name="property[interest_only]" value="No" <%= "checked" unless @property.interest_only %>> No

  </div>
  <div class="amortization2">

    <label for="property_amortization">Amortization</label><br>
    <input
      id="property_amortization"
      name="property[amortization]"
      type="number"
      value="<%= @property.amortization %>"> yrs<br><br>

  </div>

</div>
<div class="top-box">
  <div class="income2">

    <label for="property_income">Income</label><br>
    &#36; <input
      id="property_income"
      name="property[income]"
      type="number"
      step="1"
      value="<%= @property.income.to_i %>"><br><br>

  </div>
  <div class="expenses2">

    <label for="property_expenses">Expenses</label><br>
    &#36; <input
      id="property_expenses"
      name="property[expenses]"
      type="number"
      step="1"
      value="<%= @property.expenses.to_i %>"><br><br>

  </div>

</div>

</form>
<br><br>

<div class="top-box">
  <div class="inner">Investment @ <br><span class="cap-rate-span"><%= @property.cap_rate %></span>% Cap Rate</div>
  <div class="investment-top">&#36;<span id="purchase-price-span"><%= @property.purchase_price.to_i %></span></div>
</div>
<div class="top-box">
  <div class="inner4">Leveraged (Borrowing) vs. Unleveraged</div>
  <div class="middle2"></div>
  <div class="left">&#36;<span id="loan-amount-span"><%= @property.loan_amount.to_i %></span> &#64;<br><font color="black"><span id="interest-rate-span"><%= remove_trailing_zeros(@property.interest_rate) %></span>&#37;</font> Interest</div>
  <div class="right">Borrow <br>Nothing</div>
</div>
<div class="top-box">
  <div class="inner">Net Operating <br>Income</div>
  <div class="investmentb"></div>
  <div class="left2">&#36;<span class="net-operating-income-span"><%= @property.net_operating_income.to_i %></span></div>
  <div class="right2">&#36;<span class="net-operating-income-span"><%= @property.net_operating_income.to_i %></span></div>
</div>
<div class="top-box">
  <div class="inner">Debt Service <br>Payments</div>
  <div class="investmentb"></div>
  <div class="left2">&#36;<span id="debt-service-span"><%= @property.debt_service.to_i %></span></div>
  <div class="right2">$0</div>
</div>
<div class="top-box">
  <div class="inner2">Cash Flow</div>
  <div class="investment2b"></div>
  <div class="left3">&#36;<span id="cash-flow-span"><%= @property.cash_flow.to_i %></span></div>
  <div class="right3">&#36;<span class="net-operating-income-span"><%= @property.net_operating_income.to_i %></span></div>
</div>
<div class="top-box">
  <div class="inner3">Cash on Cash <br>(Income Earned / <br>Initial Investment)</div>
  <div class="middle-result2"></div>
  <div class="left-result"><span id="cash-on-cash-span"><%= @property.cash_on_cash %></span>&#37;</div>
  <div class="right-result"><span class="cap-rate-span"><%= @property.cap_rate %></span>&#37;</div>
</div>
<div class="flow"></div>
<div class="flow2b"></div>
<div class="down-payment"><b>Down Payment</b><br>&#36; <span id="down-payment-span"><%= @property.down_payment.to_i %></span></div>
<div class="loan-to-value"><b>Loan to value<br>(LTV &#37;)</b><br><span id="loan-to-value-span"><%= @property.loan_to_value %></span> &#37;</div>
<div class="dscr"><b>Debt Service<br>Coverage Ratio<br>(DSCR)</b><br><span id="dscr-span"><%= @property.dscr %></span></div>


</div>
<center><a href="/equations.txt">Link to equations</a><br><br></center>








<h3>Page Views</h3>
(does not count logged in user on own properties)

<% data = @property.views.group_by_day(:created_at).count %>
<% new_data = {} %>
<% data.each { |key, value| new_data[key.to_date] = value } %>

<%= line_chart(new_data, discrete: true) %>

<h3>Showings</h3>

<% data = @property.showings.group_by_day(:created_at).count %>
<% new_data = {} %>
<% data.each { |key, value| new_data[key.to_date] = value } %>

<%= line_chart(new_data, discrete: true) %>

<br>
<div class="group">
  <% @property.showings.each do |showing| %>
    <div class="showing"> 
      <%= showing.name %><br>
      <%= showing.title %><br>
      <%= showing.email %><br>
      <%= showing.company %><br>
      <%= showing.phone %><br>
    </div>
  <% end %>
</div>


</div>

<br><br><br><br>

<input class="number">


<script language="JavaScript">

  function truncate(x) {
    return Math.round(x * 100) / 100.0;
  }

  var addCommas = function(event) {
    if(event.which >= 37 && event.which <= 40){
      event.preventDefault();
    }
    var $this = $(this);
    var num = $this.val().replace(/(\s)/g, '');
    num = num.replace (/,/g, "");
    $this.val(num.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,"));
  }

  function updateFields() {

    String.prototype.capitalize = function() {
      return this.charAt(0).toUpperCase() + this.slice(1);
    }

    var data = $("#property-form").serializeJSON();

    var success = function (data) {
      $("#errors").text("");

      var purchasePrice = Math.floor($("#property_purchase_price").val());
      var loanAmount = Math.floor($("#property_loan_amount").val());
      var interestRate = truncate($("#property_interest_rate").val());

      var netOperatingIncome = data["net_operating_income"];
      var debtService = data["debt_service"];
      var cashFlow = data["cash_flow"];
      var cashOnCash = data["cash_on_cash"];
      var capRate = data["cap_rate"];
      var downPayment = data["down_payment"];
      var loanToValue = data["loan_to_value"];
      var dscr = data["dscr"];

      $("#purchase-price-span").text(purchasePrice);
      $("#loan-amount-span").text(loanAmount);
      $("#interest-rate-span").text(interestRate);

      $(".net-operating-income-span").text(netOperatingIncome);
      $("#debt-service-span").text(debtService);
      $("#cash-flow-span").text(cashFlow);
      $("#cash-on-cash-span").text(cashOnCash);
      $(".cap-rate-span").text(capRate);
      $("#down-payment-span").text(downPayment);
      $("#loan-to-value-span").text(loanToValue);
      $("#dscr-span").text(dscr);
    };

    var error = function (data) {
      $("#errors").text("");
      var $errorTitle = $("<h3>Please fix the following errors:</h3>");
      $("#errors").append($errorTitle);
      var responseText = data["responseText"];
      var responseObj = JSON.parse(responseText);
      var keys = Object.keys(responseObj);
      for (var i=0; i<keys.length; i++) {
        var key = keys[i];
        $("#errors").append(
          key.replace(/_/g, ' ').capitalize() + 
          " " + responseObj[key] + "<br />"
        );
      }
      $("#errors").append($("<hr>"));
    }

    $.ajax({
      type: "PUT",
      url: "<%= api_property_url(@property) %>",
      data: data,
      success: success,
      error: error,
      dataType: "json"
    });

  }

  $('input.number').change(addCommas);

  //setup onchange and onkeyup to call updatefields when value has changed
  //document.getElementById("property-form").onchange = updateFields;
  //document.getElementById("property-form").onkeyup = updateFields;


  

</script>







